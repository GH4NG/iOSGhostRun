name: Release

on:
    push:
        tags:
            - 'v*'
    workflow_dispatch:
        inputs:
            tag:
                description: 'Release tag'
                required: true
                type: string

permissions:
    contents: write

jobs:
    build:
        name: Build ${{ matrix.name }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    # Linux build
                    - os: ubuntu-24.04
                      platform: linux
                      name: Linux_X64

                    # Linux arm build
                    - os: ubuntu-24.04-arm
                      platform: linux
                      name: Linux_ARM

                    # Windows build
                    - os: windows-latest
                      platform: windows
                      name: Windows

                    # macOS build
                    - os: macos-latest
                      platform: darwin
                      name: macOS

        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: 'stable' # Latest stable version

            - name: Set up Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: 'latest'

            - name: Install Dependencies
              if: ${{ matrix.platform == 'linux' }}
              run: |
                  sudo apt update
                  sudo apt-get install -y build-essential pkg-config libgtk-3-dev libwebkit2gtk-4.1-dev

            - name: Install Wails CLI
              run: go install github.com/wailsapp/wails/v3/cmd/wails3@latest

            - name: Install Task
              uses: arduino/setup-task@v2
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}

            - name: Build
              run: wails3 package

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: app-${{ matrix.name }}
                  path: |
                      bin/*.AppImage
                      bin/*.exe
                      bin/*.zip

    release:
        needs: build
        runs-on: ubuntu-latest

        steps:
            - name: Download artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Prepare release files
              run: |
                  mkdir -p release
                  find artifacts -type f -exec mv {} release/ \;
                  ls -la release/

            - name: Get tag name
              id: tag
              run: |
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
                    echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
                  else
                    echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
                  fi

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.tag.outputs.tag }}
                  name: Release ${{ steps.tag.outputs.tag }}
                  draft: false
                  prerelease: false
                  files: release/*
                  body: |
                      ## iOSGhostRun ${{ steps.tag.outputs.tag }}
