version: '3'

includes:
    common: ../Taskfile.yml

tasks:
    build:
        summary: Builds the application for Windows
        deps:
            - task: common:go:mod:tidy
            - task: common:build:frontend
              vars:
                  PRODUCTION: '{{.PRODUCTION}}'
            - task: common:generate:icons
        cmds:
            - task: generate:syso
            - go build {{.BUILD_FLAGS}} -o {{.BIN_DIR}}/{{.APP_NAME}}-{{.ARCH}}.exe
            - cmd: powershell Remove-item *.syso
              platforms: [windows]
            - cmd: rm -f *.syso
              platforms: [linux, darwin]
        vars:
            BUILD_FLAGS: '{{if eq .PRODUCTION "true"}}-tags production -trimpath -buildvcs=false -ldflags="-w -s -H windowsgui"{{else}}-buildvcs=false -gcflags=all="-l"{{end}}'
            ARCH: '{{.ARCH | default ARCH}}'
        env:
            GOOS: windows
            CGO_ENABLED: 0
            GOARCH: '{{.ARCH}}'
            PRODUCTION: '{{.PRODUCTION | default "false"}}'

    package:
        summary: Packages a production build of the application for both AMD64 and ARM64 architectures into a `.exe` bundle
        cmds:
            - task: build
              vars:
                  ARCH: amd64
                  PRODUCTION: 'true'
            - task: build
              vars:
                  ARCH: arm64
                  PRODUCTION: 'true'

    generate:syso:
        summary: Generates Windows `.syso` file
        dir: build
        cmds:
            - wails3 generate syso -arch {{.ARCH}} -icon windows/icon.ico -manifest windows/wails.exe.manifest -info windows/info.json -out ../wails_windows_{{.ARCH}}.syso
        vars:
            ARCH: '{{.ARCH | default ARCH}}'

    run:
        cmds:
            - '{{.BIN_DIR}}\\{{.APP_NAME}}-{{.ARCH | default ARCH}}.exe'
