version: '3'

includes:
    common: ../Taskfile.yml

tasks:
    build:
        summary: Builds the application for macOS
        deps:
            - task: common:go:mod:tidy
            - task: common:build:frontend
              vars:
                  BUILD_FLAGS:
                      ref: .BUILD_FLAGS
                  DEV:
                      ref: .DEV
            - task: common:generate:icons
        cmds:
            - go build {{.BUILD_FLAGS}} -o {{.OUTPUT}}
        vars:
            BUILD_FLAGS: '{{if eq .DEV "true"}}-buildvcs=false -gcflags=all="-l"{{else}}-tags production -trimpath -buildvcs=false -ldflags="-w -s"{{end}}'
            ARCH: '{{.ARCH | default ARCH}}'
            DEFAULT_OUTPUT: '{{.BIN_DIR}}/{{.APP_NAME}}-{{.ARCH}}'
            OUTPUT: '{{ .OUTPUT | default .DEFAULT_OUTPUT }}'
        env:
            GOOS: darwin
            CGO_ENABLED: 1
            GOARCH: '{{.ARCH}}'

    package:
        summary: Packages the application into a universal `.app` bundle
        cmds:
            - task: build
              vars:
                  ARCH: amd64
            - task: build
              vars:
                  ARCH: arm64
            - lipo -create "{{.BIN_DIR}}/{{.APP_NAME}}-amd64" "{{.BIN_DIR}}/{{.APP_NAME}}-arm64" -output "{{.BIN_DIR}}/{{.APP_NAME}}-universal"
            - task: create:app:bundle
            - cd {{.BIN_DIR}} && zip -r {{.APP_NAME}}-darwin-universal.zip {{.APP_NAME}}.app

    create:app:bundle:
        summary: Creates an `.app` bundle for universal binary
        cmds:
            - mkdir -p "{{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/MacOS"
            - mkdir -p "{{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/Resources"
            - cp build/darwin/icons.icns "{{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/Resources"
            - cp "{{.BIN_DIR}}/{{.APP_NAME}}-universal" "{{.BIN_DIR}}/{{.APP_NAME}}.app/Contents/MacOS/{{.APP_NAME}}"
            - cp build/darwin/Info.plist "{{.BIN_DIR}}/{{.APP_NAME}}.app/Contents"

    run:
        cmds:
            - mkdir -p "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/MacOS"
            - mkdir -p "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/Resources"
            - cp build/darwin/icons.icns "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/Resources"
            - cp "{{.BIN_DIR}}/{{.APP_NAME}}-{{.ARCH | default ARCH}}" "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/MacOS/{{.APP_NAME}}"
            - cp "build/darwin/Info.dev.plist" "{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/Info.plist"
            - '{{.BIN_DIR}}/{{.APP_NAME}}.dev.app/Contents/MacOS/{{.APP_NAME}}'
